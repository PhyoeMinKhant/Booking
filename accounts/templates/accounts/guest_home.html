{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>StayFinder</title>
    <link rel="stylesheet" href="{% static 'accounts/css/guest_home.css' %}?v=20260224b" />
  </head>
  <body>
    <header class="topbar">
      <div class="brand">
        <span class="brand__icon">üè®</span>
        <span class="brand__name">StayFinder</span>
      </div>
      <div class="topbar__actions">
        {% include 'accounts/partials/notifications_menu.html' %}
        <details class="profile-menu">
          <summary class="profile-trigger">
            <span class="profile-trigger__content">
              <span class="profile-trigger__avatar">
                {% if profile.profile_image %}
                  <img src="{{ profile.profile_image.url }}" alt="Profile photo" />
                {% elif profile.profile_image_url %}
                  <img src="{{ profile.profile_image_url }}" alt="Profile photo" />
                {% else %}
                  <span class="profile-trigger__initial">{{ profile.full_name|slice:":1" }}</span>
                {% endif %}
              </span>
              <span class="profile-trigger__text">
                <span class="profile-trigger__name">
                  {{ request.user.get_full_name|default:request.user.username }}
                </span>
              </span>
              <span class="profile-trigger__chevron">‚ñæ</span>
            </span>
          </summary>
          <div class="profile-dropdown" role="menu">
            <a class="profile-item" href="{% url 'guest_profile' %}" role="menuitem">
              <span class="profile-item__icon">üë§</span>
              <span class="profile-item__content">
                <span class="profile-item__title">Account Information</span>
                <span class="profile-item__subtitle">View your profile details</span>
              </span>
            </a>
            <a class="profile-item" href="{% url 'booking_history' %}" role="menuitem">
              <span class="profile-item__icon">üìÖ</span>
              <span class="profile-item__content">
                <span class="profile-item__title">Booking History</span>
                <span class="profile-item__subtitle">View all your bookings</span>
              </span>
            </a>
            <div class="profile-divider"></div>
            <a class="profile-item profile-item--danger" href="{% url 'logout' %}" role="menuitem">
              <span class="profile-item__icon">‚Üó</span>
              <span class="profile-item__title">Sign Out</span>
            </a>
          </div>
        </details>
      </div>
    </header>

    <main class="hero">
      <div class="hero__content">
        <h1>Find Your Perfect Stay</h1>
        <p>Search thousands of hotels worldwide</p>
      </div>

      <section class="search-card">
        <form class="search-form" id="hotel-search-form" method="get" action="{% url 'home' %}">
          <label class="field">
            <span>Location</span>
            <input
              type="text"
              name="location"
              placeholder="Enter city name"
              value="{{ search_params.location }}"
            />
          </label>
          <label class="field">
            <span>Hotel Name</span>
            <input
              type="text"
              name="hotel_name"
              placeholder="Search by hotel name"
              value="{{ search_params.hotel_name }}"
            />
          </label>
          <label class="field">
            <span>Check-in</span>
            <input type="date" name="checkin" value="{{ search_params.checkin }}" />
          </label>
          <label class="field">
            <span>Check-out</span>
            <input type="date" name="checkout" value="{{ search_params.checkout }}" />
          </label>
          <label class="field">
            <span>Guests</span>
            <input
              type="number"
              name="guests"
              value="{{ search_params.guests|default:2 }}"
              min="1"
            />
          </label>
          <button class="primary-button" type="submit">Search Hotels</button>
        </form>
      </section>

      <section
        class="results {% if search_performed %}results--visible{% endif %}"
        id="hotel-results"
        aria-live="polite"
      >
        <header class="results__header">
          <h2>Available Hotels</h2>
          {% if search_performed %}
            <p>Found {{ rooms|length }} room{{ rooms|length|pluralize }} matching your search</p>
          {% else %}
            <p>Search to see available rooms</p>
          {% endif %}
        </header>
        {% if search_error %}
          <p>{{ search_error }}</p>
        {% endif %}

        <div class="results__grid">
          {% if search_performed and rooms %}
            {% for room in rooms %}
              <article class="hotel-card">
                <div class="hotel-card__media">
                  {% with facility_images=room.hotel.facility_images.all %}
                    {% if facility_images %}
                      <div class="facility-slider" data-slider>
                        <div class="facility-slider__track">
                          {% for facility_image in facility_images %}
                            <div class="facility-slider__slide{% if forloop.first %} is-active{% endif %}">
                              <img
                                src="{{ facility_image.image.url }}"
                                alt="{{ room.hotel.full_name }} facility image {{ forloop.counter }}"
                              />
                            </div>
                          {% endfor %}
                        </div>
                        {% if facility_images|length > 1 %}
                          <button
                            class="facility-slider__control facility-slider__control--prev"
                            type="button"
                            data-direction="prev"
                            aria-label="Previous facility image"
                          >
                            ‚Äπ
                          </button>
                          <button
                            class="facility-slider__control facility-slider__control--next"
                            type="button"
                            data-direction="next"
                            aria-label="Next facility image"
                          >
                            ‚Ä∫
                          </button>
                        {% endif %}
                      </div>
                    {% else %}
                      <span class="hotel-card__fallback">üè®</span>
                    {% endif %}
                  {% endwith %}
                </div>
                <div class="hotel-card__body">
                  <h3>{{ room.hotel.full_name }}</h3>
                  <p class="hotel-card__location">üìç {{ room.hotel.location|default:"Location unavailable" }}</p>
                  <div class="hotel-card__meta">
                    <span class="hotel-card__rating">{{ room.room_type.name }}</span>
                    <span class="hotel-card__price">
                      ${{ room.rate_per_night }} <small>per night</small>
                    </span>
                  </div>
                  <p class="hotel-card__location">
                    {{ room.capacity }} guests ¬∑ {{ room.available_rooms }} rooms
                  </p>
                  <p class="hotel-card__location">
                    {{ room.checkin_date }} to {{ room.checkout_date }}
                  </p>
                  <div class="hotel-card__actions">
                    <a class="hotel-card__action hotel-card__action--secondary" href="{% url 'guest_hotel_profile' room.hotel.id %}">
                      View Hotel Profile
                    </a>
                    <a class="hotel-card__action" href="{% url 'booking_checkout' room.id %}">Book Now</a>
                  </div>
                </div>
              </article>
            {% endfor %}
          {% elif search_performed %}
            <p>No rooms match your search yet. Try adjusting your dates or guests.</p>
          {% endif %}
        </div>
      </section>
    </main>
    <script>
      document.querySelectorAll("[data-slider]").forEach((slider) => {
        const slides = Array.from(slider.querySelectorAll(".facility-slider__slide"));
        if (slides.length < 2) {
          return;
        }

        let activeIndex = 0;
        const setActiveSlide = (index) => {
          slides[activeIndex].classList.remove("is-active");
          activeIndex = (index + slides.length) % slides.length;
          slides[activeIndex].classList.add("is-active");
        };

        slider.querySelectorAll(".facility-slider__control").forEach((button) => {
          button.addEventListener("click", () => {
            const step = button.dataset.direction === "prev" ? -1 : 1;
            setActiveSlide(activeIndex + step);
          });
        });

        setInterval(() => {
          setActiveSlide(activeIndex + 1);
        }, 3500);
      });
    </script>
  </body>
</html>
