<details class="notification-menu">
  <summary class="icon-button icon-button--notify" aria-label="Notifications">
    <svg class="icon-button__svg" viewBox="0 0 24 24" aria-hidden="true">
      <path
        d="M15 17H9m8-5V9a5 5 0 0 0-10 0v3l-1.6 2.4A1 1 0 0 0 6.2 16h11.6a1 1 0 0 0 .8-1.6L17 12Z"
        fill="none"
        stroke="currentColor"
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="1.6"
      />
    </svg>
    {% if booking_notifications_unread_count > 0 %}
      <span class="icon-button__count" aria-hidden="true">
        {% if booking_notifications_unread_count > 9 %}
          9+
        {% else %}
          {{ booking_notifications_unread_count }}
        {% endif %}
      </span>
    {% endif %}
  </summary>
  <div class="notification-dropdown" role="menu">
    <p class="notification-title">Notifications</p>
    <ul class="notification-list">
      {% for notification in booking_notifications %}
        <li class="notification-item{% if not notification.is_read %} notification-item--unread{% endif %}">
          <a class="notification-item__link{% if not notification.is_read %} notification-item__link--unread{% endif %}" href="{{ notification.history_url }}">
            <span class="notification-item__text">{{ notification.message }}</span>
            <span class="notification-item__time">{{ notification.created_at|date:"M j, g:i A" }}</span>
          </a>
        </li>
      {% empty %}
        <li class="notification-empty">No notifications yet.</li>
      {% endfor %}
    </ul>
  </div>
</details>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".notification-menu .notification-item__link").forEach(function (link) {
      link.addEventListener("click", function () {
        var item = this.closest(".notification-item");
        var menu = this.closest(".notification-menu");
        var list = menu ? menu.querySelector(".notification-list") : null;
        if (item && item.classList.contains("notification-item--unread")) {
          item.remove();
        }

        if (menu && !menu.querySelector(".notification-item--unread")) {
          var notificationCount = menu.querySelector(".icon-button__count");
          if (notificationCount) {
            notificationCount.remove();
          }
          var legacyDot = menu.querySelector(".icon-button__dot");
          if (legacyDot) {
            legacyDot.remove();
          }

          if (list && !list.querySelector(".notification-empty")) {
            var emptyItem = document.createElement("li");
            emptyItem.className = "notification-empty";
            emptyItem.textContent = "No notifications yet.";
            list.appendChild(emptyItem);
          }
        } else if (menu) {
          var updatedUnread = menu.querySelectorAll(".notification-item--unread").length;
          var countBadge = menu.querySelector(".icon-button__count");
          if (countBadge) {
            countBadge.textContent = updatedUnread > 9 ? "9+" : String(updatedUnread);
          }
        }

        if (menu) {
          menu.removeAttribute("open");
        }
      });
    });
  });
</script>
